<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nguyen's Blackjack Game</title>
<link rel="stylesheet" href="styles/style.css">

<script>

let deck = [];
let shuffledDeck = []
let hand = [];
let dealerCards = [];
const suits = ["hearts", "clubs", "diamonds", "spades"];
const ranks = ["ace", 2, 3, 4, 5, 6, 7, 8, 9, 10, "jack", "queen", "king"];
const values = ["ace", 2, 3, 4, 5, 6, 7, 8, 9, 10, 10, 10, 10];

function Card(suit, rank, value){ // card constructor
    this.suit = suit; 
    this.rank = rank; 
    this.value = value; 
    this.isVisible = false; 
    this.isDealt = false;
    this.image = `images/${this.rank}_of_${this.suit}.svg`;
    this.show = function (){ 
        this.isVisible = true;
    };
    this.hide = function (){
        this.isVisible = false;
    };
    this.display = function(){
        if (this.isVisible) {
            return `<img src="${this.image}" height="87" width="100">`;
        } else {
            return '<img src="images/back.png" height="87" width="60">';
        }
    };
    
};

function validateUserName(username){ // validates user input
    return new Promise(function(resolve,reject){
        if(!username.trim()){
            reject("Please input a username to begin!");
            return;
        }
        var regex = /^[a-zA-Z]{1,799}$/;
        if(!regex.test(username)){ // contains non alpha numeric characters
            reject("Invalid username! Please do not use spaces, numbers, or special characters")
            return;
        }
        resolve(username);
    })
};

function createDeck(){ // creates new card objects using previously declared arrays and adds them to deck
    for (let i = 0; i < 4; i++){
        for (let n = 0; n < 13; n++){
            deck.push(new Card(suits[i], ranks[n], values[n]));
        }                
    }
    shuffleDeck(); // calls function to shuffle order
};

function shuffleDeck(){ // reorders deck array objects into new array
    let tempDeck = deck;
    shuffledDeck = [];
    for(let i = 52; i > 0; i--){
        let picked = Math.floor(Math.random()*(tempDeck.length));
        shuffledDeck.push(tempDeck[picked]);
        tempDeck.splice(picked,1);
    };
    dealInitialCards(); // deal cards after shuffle
    console.log("Deck shuffled and new cards dealt");
};

function dealInitialCards(){
    dealerCards.push(shuffledDeck[1]); // gives dealer second card face up
    shuffledDeck[1].isDealt = true;
    dealerCards[0].show();

    dealerCards.push(shuffledDeck[3]); // gives dealer fourth card face down
    shuffledDeck[3].isDealt = true;
    dealerCards[1].hide();

    hand.push(shuffledDeck[0]); // gives player first card face up
    shuffledDeck[0].isDealt = true;
    shuffledDeck[0].show();

    hand.push(shuffledDeck[2]); // gives player third card face up
    shuffledDeck[2].isDealt = true;
    shuffledDeck[2].show();

    showCards(); // calls document display function
};

// displays dealer and player cards into the document
function showCards(){
    const dealerCardDisplay = document.getElementById('dealerCards');
    const playerCardDisplay = document.getElementById('playerCards');
    // Update the inner HTML of the containers using image sources (copilot generated)
    if(dealerCardDisplay){
        dealerCardDisplay.innerHTML = dealerCards.map(c => c.display()).join(' ');
    }
    if(playerCardDisplay){
        playerCardDisplay.innerHTML = hand.map(c => c.display()).join(' ');
    }
}


function hit(){ // takes undealt card from deck and adds to user's hand
    let drawnCard;
    do{
        drawnCard = Math.floor(Math.random()*(shuffledDeck.length));
    } while (shuffledDeck[drawnCard].isDealt == true) // rerandomizes card until it is an undealt one
    hand.push(shuffledDeck[drawnCard]);
    console.log(`drew the ${hand[hand.length - 1].rank} of ${hand[hand.length - 1].suit}`);
    shuffledDeck[drawnCard].isDealt = true;
    hand[hand.length - 1].show();
    showCards(); // updates display
}
    

function stand(){    
    dealerCards[1].show(); // flips dealer's hidden card
    showCards(); 

    dealerTotal = 0;
    if (dealerCards[0].value == "ace" && dealerCards[1].value == "ace"){ // if both dealer cards are aces, sets values to 11 and 1
        dealerTotal = 11+1
    } else if (dealerCards[0].value == "ace" || dealerCards[1].value == "ace"){ // if one card is an ace, sets value to 11
        if (dealerCards[0].value == "ace"){
            dealerTotal = dealerCards[1].value + 11;
        }
        else{
            dealerTotal = dealerCards[0].value + 11;
        }
    } else {
        dealerTotal = dealerCards[1].value + dealerCards[0].value;
    }
            
    userTotal = 0;
    let userAces = 0;
    for (let i = 0; i < hand.length; i++){ // adds total excluding aces
        if (hand[i].value == "ace"){
            userAces ++;
        } else {
            userTotal += hand[i].value;
        }
    }
    if (userAces > 0){
        userTotal += (11 * userAces); // adds ace values as 11s
        if (userTotal > 21){
            do{
                userTotal -= 10; // changes ace values to 1s if total is over 21
                userAces --;
            } while (userTotal > 21 && userAces > 0); // changes values until all aces changed/total goes below 21             
        };
    };


    if (userTotal > 21){ // if user has more than 21 points, they bust
        alert(`Bust! \nYou lose :( \nYour total: ${userTotal}`)
    } else {
        if ((userTotal - dealerTotal) > 0){ // if user doesn't bust but has more points than the dealer, they win
            alert(`You win! \nDealer total: ${dealerTotal} \nYour total: ${userTotal} \nDifference: ${userTotal - dealerTotal}`)
        }
        else if ((userTotal - dealerTotal) == 0){ // if the user has equal points to the dealer, they tie
            alert(`You tied! \nDealer total: ${dealerTotal} \nYour total: ${userTotal} \nDifference: ${userTotal - dealerTotal}`)
        }
        else if ((userTotal - dealerTotal) < 0){ // if user has fewer points than the dealer, they lose
            alert(`You lost! \nDealer total: ${dealerTotal} \nYour total: ${userTotal} \nDifference: ${dealerTotal - userTotal}`)
        }
    }
};

function returnToForm(){
    document.getElementById('gameArea').style.display = 'none';
    document.getElementById('userForm').style.display = 'block';
    shuffledDeck = [];
    hand = [];
    dealerCards = [];
    document.getElementById('dealerCards').innerHTML = "";
    document.getElementById('playerCards').innerHTML = "";
};

// Start game
async function startGame() {
    var username = document.userForm.elements[0].value.trim();
    try {
        var validUsername = await validateUserName(username);
        document.getElementById('userForm').style.display = 'none';
        document.getElementById('gameArea').style.display = 'block';
        document.getElementById('welcomeMessage').textContent = `Welcome ${validUsername}!`;

        createDeck();
    } catch (error) {
        alert(error);
    }
}

</script>
</head>
<body>
<div class="game-container">
    <h1>Blackjack Game</h1>
    <form name="userForm" id="userForm" style="display: block;">
        Enter your name: <input type="text"> 
        <input type="button" value="Start Game" onclick="startGame()">
    </form>
</div>

<div id="gameArea" style="display: none;">
    <h2 id="welcomeMessage"></h2>

    <div>
        <h3>Dealer's Cards:</h3>
        <div id="dealerCards" class="cards"></div>
    </div>

    <div>
        <h3>Your Cards:</h3>
        <div id="playerCards" class="cards"></div>
    </div>

    <div id="buttons">
        <button id="hitButton" onclick="hit()">Hit</button>
        <button id="standButton" onclick="stand()">Stand</button>
        <button id="shuffleButton" onclick="shuffleDeck()">Shuffle (currently not functional)</button>
    </div>

    <h3 id="resultMessage"></h3>

    <button onclick="returnToForm()">Return to Form</button>
</div>
</body>
</html>
